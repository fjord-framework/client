<!DOCTYPE html>
<html>

<head>
  <title>Streaming Records</title>
</head>
<style>
  th,
  td {
    margin: 20px;
    padding: 10px;
  }
</style>

<body>
  <h2>Streaming Records</h2>
  <table>
    <thead>
      <tr>
        <th>Topic</th>
        <th>Timestamp</th>
        <th>Key</th>
        <th>Value</th>
      </tr>
    </thead>
    <tbody id="table">
      <!-- New rows received from server will go here -->
    </tbody>
  </table>

  <script>
    // Public address of the AWS Load Balancer (get this from the Fjord-App CLI output)
    const host = "http://fjord-fjord-QTMUFOQ5C9PB-757494948.us-east-1.elb.amazonaws.com"
    
    // Name of the topic you want this client to listen to; could also be hard-coded into the url below
    const topic = "orders";
    
    // This would be a unique userID from the currently logged in user on your server
    const userID = 'jill453df'; 

    // Token generated by your server using the same private key deployed to Fjord/AWS
    // Ideally, save this token on & pull from localstorage
    const token = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiIzZHU1azdldWUyMmtrajR6aTNlYyIsImV4cCI6MTYyODEwNDM1MiwiaWF0IjoxNjI4MDk4MzUyfQ.VVTKv00Hg5LTjDS2pSUBIof0hM3EP8aFeMmOYZ21hag";

    const url = `${host}/stream/${topic}/${userID}/${token}`; // (N.B. omit /token if JWT is not used)
    const events = new EventSource(url);

    const table = document.getElementById("table")

    events.onmessage = e => {
      const record = JSON.parse(e.data);
      if (record.value) {
        const row = table.insertRow(0)       // first row (i.e. newest record added at top of table)
        const col1 = row.insertCell(0)
        const col2 = row.insertCell(1)
        const col3 = row.insertCell(2)
        const col4 = row.insertCell(3)
        col1.appendChild(document.createTextNode(record.topic));
        col2.appendChild(document.createTextNode(record.timestamp));
        col3.appendChild(document.createTextNode(record.key));
        col4.appendChild(document.createTextNode(record.value));
      }
    };

    events.onerror = e => {
      console.log('Server got disconnected. Attempting again');
    }

  </script>
</body>

</html>